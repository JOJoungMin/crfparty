<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Party Cards</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
   
</head>

<body>
  <h1>로컬 저장소에서 토큰 확인</h1>
  <div id="tokenValue"></div>
    <div class="container mt-4">

        <div class="row">
            <button class="btn btn-primary ms-3 mb-3" data-bs-toggle="modal" data-bs-target="#myModal">create</button>
        </div>

        <!-- 모달 -->
    <div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">정보 입력</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label for="title" class="form-label">제목:</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="name" class="form-label">카테고리:</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="content" class="form-label">내용:</label>
                            <textarea class="form-control" id="content" name="content" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="date" class="form-label">일시:</label>
                            <input type="datetime-local" class="form-control" id="date" name="date" required>
                        </div>
                        <div class="mb-3">
                            <label for="participants" class="form-label">인원:</label>
                            <input type="number" class="form-control" id="participants" name="participants" required>
                        </div>
                        <!-- post 버튼 함수 걸어주기기 -->
                        <button type="submit" class="btn btn-primary" id="postPtData">제출</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <div class="row" id="card-box">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span class="badge bg-success">Health</span>
                    <span class="text-muted"><i class="bi bi-people"></i> 3/5</span>
                </div>
                <div class="card-body">
                    <h5 class="card-title">Morning Workout Group</h5>
                    <div class="d-flex align-items-center mb-2">
                        <small class="text-muted">Founded by Alex Kim</small>
                    </div>
                    <p class="card-text">Join us for morning workouts including jogging, stretching, and basic strength training. All fitness levels welcome!</p>
                    <div class="d-flex text-muted small mb-3">
                        <span><i class="bi bi-calendar"></i> Mon, Wed, Fri</span>
                        <span class="ms-3"><i class="bi bi-clock"></i> 7:00 AM</span>
                    </div>
                    <button class="btn btn-primary w-100" id="joinBtn">Join Party</button>
                </div>
            </div>
        </div>

    </div>
    
    </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.min.js"></script>

   
    <script>
        const token = localStorage.getItem('token');
        tokenob = JSON.parse(token);

        const UserName = tokenob.user_name;
        const partyCode = tokenob.user_cord;

        
         
        

        //본인이 로그인한다면 뽑을 수 있는 데이터터
        const partymember = "이영준";
        const partymemberCord = "9-23"; 
      
        // post 하며 파티의 내용을 보내는 버튼의 변수
        const $postPtBtn = document.querySelector('#postPtData');
        const $joinBtn = document.querySelector('#joinBtn');


        const $title = document.querySelector('#title');
        const $category = document.querySelector('#name'); // 'name' 대신 'category'로 변경
        const $content = document.querySelector('#content');
        const $date = document.querySelector('#date');
        const $participants = document.querySelector('#participants');
        const $cardBox = document.querySelector('#card-box');

        $postPtBtn.addEventListener('click', ()=>postPtData());
        
        document.addEventListener("DOMContentLoaded", function () {
        let result = [];
        fetch("http://127.0.0.1:5000/lodingdata")
          .then((response) => response.json())
          .then((data) => {
           
            if (data && data.length > 0) {
              for (let i = 0; i < data.length; i++) {
                addparty(data[i].category_give, data[i].partparticipants_give, data[i].title_give, 
                data[i].partymaneserName, data[i].partymanaser_cord, data[i].content_give, data[i].date_give, data[i].userArr);
                console.log(data[i]);
              }
            }
          }) .catch((error) => console.error("에러발생", error))
        });
         

        function addparty(category, participants, title, partyName, partyCord, content, date, memberArr){
           

          let checkCode = {
            check: false,
            index: 0
          }

          for(let i =0; i<memberArr.length;i++){
            if(partyCode===memberArr[i]){
              checkCode.check = true;
              checkCode.index = i
              break;
            }
          }

          if(checkCode.check){

       
              let partyCard = `
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span class="badge bg-success">${category} 파티참여</span>
                    <span class="text-muted"><i class="bi bi-people"></i>희망인원${participants}</span>
                </div>
                <div class="card-body">
                    <h5 class="card-title">${title}</h5>
                    <div class="d-flex align-items-center mb-2">
                        <small class="text-muted">${partyName} ${partyCord}.</small>
                    </div>
                    <p class="card-text">${content}</p>
                    <div class="d-flex text-muted small mb-3">
                        <span><i class="bi bi-calendar"></i> ${date}</span>
                        <span class="ms-3"><i class="bi bi-clock"></i> 7:00 AM</span>
                    </div>

                    <button class="btn btn-primary w-100" id="deleteBtn">파티 탈퇴</button>
                </div>
            </div>
            `;
            const cardElement = document.createElement("div");
            cardElement.innerHTML = partyCard;
            cardElement.className = "col-md-4";
           
            const $deleteBtn = cardElement.querySelector("#deleteBtn").addEventListener('click',()=>quitParty(checkCode.index,partyCard))
            $cardBox.appendChild(cardElement);        
            }
           
          


          if(partyCode===partyCord){
            let managerCard = `
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span class="badge bg-success">${category} 파티장: ${UserName}</span>
                    <span class="text-muted"><i class="bi bi-people"></i>희망인원${participants}</span>
                </div>
                <div class="card-body">
                    <h5 class="card-title">${title}</h5>
                    <div class="d-flex align-items-center mb-2">
                        <small class="text-muted">${partyName} ${partyCord}.</small>
                    </div>
                    <p class="card-text">${content}</p>
                    <div class="d-flex text-muted small mb-3">
                        <span><i class="bi bi-calendar"></i> ${date}</span>
                        <span class="ms-3"><i class="bi bi-clock"></i> 7:00 AM</span>
                    </div>

                    <button class="btn btn-primary w-100" id="deleteBtn">삭제버튼</button>
                </div>
            </div>
            `;
            const cardElement = document.createElement("div");
            cardElement.innerHTML = managerCard;
            cardElement.className = "col-md-4";
           
            const $deleteBtn = cardElement.querySelector("#deleteBtn").addEventListener('click',()=>deleteParty())
            $cardBox.appendChild(cardElement);        

          } else {
          let card = `
         
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span class="badge bg-success">${category}</span>
                    <span class="text-muted"><i class="bi bi-people"></i>희망인원${participants}</span>
                </div>
                <div class="card-body">
                    <h5 class="card-title">${title}</h5>
                    <div class="d-flex align-items-center mb-2">
                        <small class="text-muted">${partyName} ${partyCord}.</small>
                    </div>
                    <p class="card-text">${content}</p>
                    <div class="d-flex text-muted small mb-3">
                        <span><i class="bi bi-calendar"></i> ${date}</span>
                        <span class="ms-3"><i class="bi bi-clock"></i> 7:00 AM</span>
                    </div>
                    <button class="btn btn-primary w-100" id="joinBtn">참석버튼</button>
                 
                </div>
            </div>`
        
        const cardElement = document.createElement("div");
        cardElement.innerHTML = card;
        cardElement.className = "col-md-4";
        const $joinBtn = cardElement.querySelector('#joinBtn').addEventListener('click', ()=>joinParty(partyCord))
        $cardBox.appendChild(cardElement);        

    }}
    
    function quitParty(index,partyCode){
      fetch("http://127.0.0.1:5000/quitParty", {
            method: "POST",
            headers: {
              "Content-Type": "application/json", // 요청 헤더
            },
            body: JSON.stringify({
              partyCode: partyCode,
              index: index,
            
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.result) {
             
                console.log("성공");
                window.location.reload();
              } else {
                console.log("실패");
              }
            })
            .catch((error) => console.error("에러발생", error));
        }
    

    function joinParty(partyCord_give){
        fetch("http://127.0.0.1:5000/joinParty", {
            method: "POST",
            headers: {
              "Content-Type": "application/json", // 요청 헤더
            },
            body: JSON.stringify({
                partyCord_give: partyCord_give,
                party_member: UserName,
                partymember_cord: partyCode,
            
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.result) {
             
                console.log("성공");
                window.location.reload();
              } else {
                console.log("실패");
              }
            })
            .catch((error) => console.error("에러발생", error));
        }
       




       function deleteParty(){
        fetch("http://127.0.0.1:5000/deleteParty", {
            method: "POST",
            headers: {
              "Content-Type": "application/json", // 요청 헤더
            },
            body: JSON.stringify({
            
            partyCord_give: partyCode,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.result) {
                window.location.reload();
                console.log("성공");
              } else {
                console.log("실패");
              }
            })
            .catch((error) => console.error("에러발생", error));
        }
       




        function postPtData(){
            fetch("http://127.0.0.1:5000/postPtdata", {
            method: "POST",
            headers: {
              "Content-Type": "application/json", // 요청 헤더
            },
            body: JSON.stringify({
            title_give: $title.value,
            category_give: $category.value,
            content_give: $content.value,
            date_give: $date.value,
            partparticipants_give: $participants.value,
            name_give: UserName,
            partyCord_give:partyCode,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.result) {
                window.location.reload();
                console.log("성공");
              } else {
                console.log("실패");
              }
            })
            .catch((error) => console.error("에러발생", error));
        }
      
        
       
// 제목, 작성자, 인원, 내용, 일시시



        

        
    </script>
    
</body>

</html>